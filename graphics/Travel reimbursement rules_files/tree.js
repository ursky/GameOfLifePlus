define(["jquery","JobRunner","jsTree","tree-finder"],function(m,r){m.jstree.idregex=/[\\:&!^|()\[\]<>@*'+~#";.,=\- \/${}%?`]/g;var d=m("meta[name=form_token]").attr("content");var h=function(I){var H={};m.each(I,function(){if(this.data&&typeof this.data.type==="string"){H[this.data.type]=true}});var J=[];for(var K in H){if(H.hasOwnProperty(K)){J.push(K)}}return J};var j=function(K,L,J){L=m.proxy(L,this);if(K.id==="#"&&!K.data){var I=L;L=function(N){var M=h(N);if(M.length>0){K.data={validChildren:M}}I(N)}}var H=K.data&&K.data.childrenURL;J=J||{};if(!H){H=this.element.attr("data-url");J=m.extend({data:"children",id:K.id},J)}if(H){m.get(H,J).done(L).fail(function(){L([])})}else{L([])}};var z=function(H,I){return !H.data||!H.data.validChildren||(I.data&&H.data.validChildren.indexOf(I.data.type)>=0)};var a=function(H,K){for(var I=0;I<H.length;I++){var J=H[I];if(!J.data||!J.data["can"+K]){return false}}return true};var p=function(H){return a(H,"Copy")};var l=function(H){return a(H,"Move")};var u=function(H){return a(H,"Delete")};var b=function(I,L,K,H,J){return(I==="create_node"&&z(K,L))||(I==="rename_node"&&L.data&&L.data.canRename)||(I==="delete_node"&&L.data&&L.data.canDelete)||(I==="move_node"&&L.data&&L.data.canMove&&z(K,L))||(I==="copy_node"&&L.data&&L.data.canCopy&&z(K,L))};var k=function(H){for(var I=0;I<H.length;I++){var J=H[I];if(!J.data||!J.data.draggable){return false}}return true};var v=function(H,K){var I=H.get_node(K.id,true);if(I.hasClass("jstree-loading")){return}I.addClass("jstree-loading");var J=H.get_node(K.parent);j.call(H,J,function(M){var L=I.parent().children().index(I[0]);H.delete_node(K);m.each(M,function(N){if(!H.get_node(this)){H.create_node(J,this,L+N,N===0&&function(O){setTimeout(function(){H.get_node(O,true).find(".jstree-anchor").first().focus()},0)})}})},{offset:K.data.offset})};var G=function(H,I){H.get_node(I,true).addClass("jstree-loading");H.disable_node(I)};var c=function(H,I){H.get_node(I,true).removeClass("jstree-loading");H.enable_node(I)};var w=function(I){var H=m(I).attr("data-url");return new r({createStatusRequest:function(J){return{url:H,data:{id:J,data:"jobStatus"}}},createAnswerRequest:function(J,K){return{url:H,data:m.extend({},K,{id:J,action:"answer",form_token:d})}}})};var i=function(H,I){var J={name:I.text};if(I.data&&I.data.type){J.type=I.data.type}return H.execute("create",H.get_node(I.parent),J)};var y=function(H,I){return H.execute("delete",I)};var n=function(H,I){return H.execute("move",I,{parent:I.parent,name:I.text})};var F=function(H,J,I){return H.execute("copy",J,{parent:I})};var E=function(K,N){if(!K.data||!K.data.hasContextMenu){return}var H=this;var L=function(O){H.element.trigger("xtree.openContextMenu",{tree:H,node:K,menu:O});N.call(H,O)};if(K.data.contextMenuURL){H.contextMenuByURL=H.contextMenuByURL||{};var M=H.contextMenuByURL[K.data.contextMenuURL];if(M){L(M)}else{var J=K.data.contextMenuURL;m.get(J,function(O){H.contextMenuByURL[J]=C(O);L(O)})}}else{if(H.contextMenuByNodeType){L(H.contextMenuByNodeType[K.data.type])}else{var I=K.data.type;m.get(H.element.attr("data-url"),{data:"contextMenu"},function(O){H.contextMenuByNodeType=g(O);L(H.contextMenuByNodeType[I])})}}};var g=function(I){for(var H in I){if(I.hasOwnProperty(H)){C(I[H])}}return I};var C=function(K){for(var I in K){if(K.hasOwnProperty(I)){var J=K[I];var H=J.action||I;J.action=o(H,J.parameters)}}return K};var o=function(I,H){return function(K){var J=m.jstree.reference(K.reference);K.parameters=m.extend(true,{},H||{});J.element.trigger("xtree.contextMenu."+I,K)}};var t=function(J,I){var H={text:"New Child",children:false,data:{type:J.data&&J.data.validChildren&&J.data.validChildren[0],canRename:true,canDelete:true}};return m.extend(true,H,I||{})};var e=function(I,J){J=m.proxy(J,this);if(this.get_node(I)){J(this.get_path(I,false,true))}else{var H=this.element.attr("data-url");if(H){m.get(H,{data:"path",id:I}).done(J).fail(function(){J([])})}else{J([])}}};var B=function(J,I){var K=this.get_node(I);var L=this.get_children_dom(J);var H=m.Deferred();if(K){H.resolve(K)}else{if(z(J,I)&&L.length>0&&this.get_node(L.last()).data.type==="pagination"){this.create_node(J,I,L.length-1,m.proxy(H,"resolve"))}else{return false}}return H.promise()};var A=function(H,I,K){if(I&&I.length>0){var J=B.call(this,H,I[0]);if(J){return J.done(m.proxy(function(L){this.open_node(L,function(){A.call(this,L,I.slice(1),K)})},this))}}if(K){K(H)}};var f=function(H,J){var I=m.Deferred();e.call(H,J,function(L){var K=this.get_node("#");A.call(this,K,L,m.proxy(I,"resolve"))});return I.promise()};var x=function(H,I){return I.reduce(function(K,J){return K.then(function(L){return f(H,J).then(function(M){L.push(M);return L})})},m.Deferred().resolve([]))};var s=function(H,I){H+=H.indexOf("?")<0?"?":"&";return H+m.param(I)};var D=function(I){var J={core:{force_text:true,animation:false,themes:{name:"xwiki",responsive:I.attr("data-responsive")!=="false",icons:I.attr("data-icons")!=="false",dots:I.attr("data-edges")!=="false"}}};var H=[];if(I.attr("data-checkboxes")==="true"){H.push("checkbox")}if(I.attr("data-url")){if(I.attr("data-dragAndDrop")==="true"){H.push("dnd")}if(I.attr("data-contextMenu")==="true"){H.push("contextmenu")}if(I.attr("data-finder")==="true"){H.push("finder")}return m.extend(true,J,{core:{data:j,check_callback:b},plugins:H,dnd:{is_draggable:k},contextmenu:{items:E},finder:{url:s(I.attr("data-url"),{data:"suggestions"})}})}else{J.plugins=H;return J}};var q={openTo:function(I,J){var H=m.isArray(I);if(!H){I=[I]}J=J||m.proxy(this,"select_node");x(this,I).then(function(K){return H?K:K[0]}).done(J)},refreshNode:function(H){if(H==="#"){this.refresh()}else{this.refresh_node(H)}},execute:function(J,I,L){var H=I.data&&I.data[J+"URL"];L=L||{};if(!H){H=this.element.attr("data-url");L.action=J;L.id=I.id}L.form_token=d;var K=this.jobRunner.run(H,L);this.element.trigger("xtree.runJob",K);return K}};m.fn.xtree=function(H){return this.on("select_node.jstree",function(J,L){var I=L.instance;var K=L.node;if(K.data&&K.data.type==="pagination"){v(I,K)}else{if(L.event&&!m(L.event.target).hasClass("jstree-no-link")&&m(L.event.target).closest(".jstree-no-links").length===0){window.location.href=K.a_attr.href}}}).on("open_node.jstree",function(J,K){var I=K.node.original;if(I&&I.iconOpened){K.instance.set_icon(K.node,I.iconOpened)}}).on("close_node.jstree",function(J,K){var I=K.node.original;if(I&&I.iconOpened){K.instance.set_icon(K.node,I.icon)}}).on("create_node.jstree",function(I,J){}).on("rename_node.jstree",function(J,K){var I=K.node.data&&K.node.data.id;if(I){if(K.old!=K.text){G(K.instance,K.node);n(K.instance,K.node).always(function(){K.instance.refreshNode(K.node.parent)})}}else{G(K.instance,K.node);i(K.instance,K.node).done(function(){K.instance.refreshNode(K.node.parent)}).fail(function(){K.instance.delete_node(K.node)})}}).on("delete_node.jstree",function(J,K){var I=K.node.data&&K.node.data.id;if(I){y(K.instance,K.node).fail(function(){K.instance.refreshNode(K.parent)})}}).on("move_node.jstree",function(J,K){var I=K.node.data&&K.node.data.id;if(!I||K.parent===K.old_parent){return}G(K.instance,K.node);n(K.instance,K.node).done(function(){K.instance.refreshNode(K.parent)}).fail(function(L){K.node.data.id=null;K.instance.move_node(K.node,K.old_parent,K.old_position);setTimeout(function(){K.node.data.id=I;c(K.instance,K.node)},0)})}).on("copy_node.jstree",function(J,K){var I=K.original.data&&K.original.data.id;if(!I){return}G(K.instance,K.node);K.node.data=m.extend(true,{},K.original.data);delete K.node.data.id;F(K.instance,K.original,K.parent).done(function(){K.instance.refreshNode(K.parent)}).fail(function(L){K.instance.delete_node(K.node)})}).on("xtree.contextMenu.refresh",function(K,L){var I=m.jstree.reference(L.reference);var J=I.get_node(L.reference);I.refreshNode(J)}).on("xtree.contextMenu.create",function(L,M){var I=m.jstree.reference(M.reference);var K=I.get_node(M.reference);var J=t(K,M.parameters.template);I.create_node(K,J,"first",function(N){setTimeout(function(){I.edit(N)},0)})}).on("xtree.contextMenu.cut",function(J,K){var I=m.jstree.reference(K.reference);I.cut(I.get_selected())}).on("xtree.contextMenu.copy",function(J,K){var I=m.jstree.reference(K.reference);I.copy(I.get_selected())}).on("xtree.contextMenu.paste",function(K,L){var I=m.jstree.reference(L.reference);var J=I.get_node(L.reference);I.paste(J)}).on("xtree.contextMenu.rename",function(K,L){var I=m.jstree.reference(L.reference);var J=I.get_node(L.reference);setTimeout(function(){I.edit(J)},0)}).on("xtree.contextMenu.remove",function(J,K){var I=K.parameters.confirmationMessage===false;var L=K.parameters.confirmationMessage||"Are you sure you want to delete the selected nodes?";setTimeout(function(){if(I||window.confirm(L)){var M=m.jstree.reference(K.reference);M.delete_node(M.get_selected())}},0)}).on("xtree.contextMenu.openLink",function(K,L){var I=m.jstree.reference(L.reference);if(L.parameters.urlProperty){var J=I.get_node(L.reference);window.location=J.data[L.parameters.urlProperty]}else{var M=I.get_node(L.reference,true);window.location=M.children("a.jstree-anchor").prop("href")}}).on("xtree.contextMenu.openLinkInNewTab",function(K,L){var I=m.jstree.reference(L.reference);var J=I.get_node(L.reference,true);window.open(J.children("a.jstree-anchor").prop("href"))}).on("xtree.openContextMenu",function(I,J){var K=J.tree.get_selected(true);if(J.menu.copy){J.menu.copy._disabled=!p(K)}if(J.menu.cut){J.menu.cut._disabled=!l(K)}if(J.menu.paste){J.menu.paste._disabled=!J.tree.can_paste()}if(J.menu.rename){J.menu.rename._disabled=!J.node.data||!J.node.data.canRename}if(J.menu.remove){J.menu.remove._disabled=!u(K)}}).find('li > span[class^="wiki"] > a').unwrap().addBack().each(function(){m(this).jstree(m.extend(true,D(m(this)),H||{}));m.extend(m.jstree.reference(this),q,{jobRunner:w(this)})})};return m});